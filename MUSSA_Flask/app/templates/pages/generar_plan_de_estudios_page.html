{% extends "common/page_base.html" %}

{% block content %}
<script>

    $( function () {
        var cant_carreras = {{carreras | length}};
        if (cant_carreras == 1) {
            var opcion = document.getElementsByName('opcion-carrera')[0];
            opcion.checked = true;
        }
    });

    function actualizarHoraHasta() {
        var hora_desde_element = document.getElementById("hora_desde");
        var indice_seleccionado = hora_desde_element.selectedIndex;

        var hora_hasta_element = document.getElementById("hora_hasta");
        for (var i=0; i < hora_hasta_element.length; i++) {
            var opcion = hora_hasta_element[i];
            if (i < indice_seleccionado)
                opcion.style["display"] = "none";
            else
                opcion.style["display"] = "";
        }

        hora_hasta_element.selectedIndex = indice_seleccionado;
     }

    function agregarHorario() {
        var dia_element = document.getElementById("horario-dia")
        var dia = dia_element[dia_element.selectedIndex].innerHTML;

        var hora_desde_element = document.getElementById("hora_desde");
        var hora_desde = hora_desde_element[hora_desde_element.selectedIndex].innerHTML;

        var hora_hasta_element = document.getElementById("hora_hasta");
        var hora_hasta = hora_hasta_element[hora_hasta_element.selectedIndex].innerHTML;

        if (!horarioParaAgregarEsValido(dia, hora_desde, hora_hasta))
            return false;

        agregarHorarioATabla(dia, hora_desde, hora_hasta);
    }

    function agregarHorarioATabla(dia, hora_desde, hora_hasta) {
        var horarios_table = document.getElementById("tabla_horarios");
        var horarios = horarios_table.rows;

        var indice = horarios_table.rows.length;
        var row = horarios_table.insertRow(indice);
        var ultimo_id = horarios_table.rows[indice-1].id
        var numero_id = parseInt(ultimo_id.substr(ultimo_id.indexOf("_")+1)) + 1;
        if (isNaN(numero_id))
            numero_id = 0;

        row.id = "horario_" + numero_id;
        row.insertCell(0).innerHTML = dia;
        row.insertCell(1).innerHTML = hora_desde;
        row.insertCell(2).innerHTML = hora_hasta;
        row.insertCell(3).innerHTML = '<button type="button" class="btn btn-default" onclick="eliminarHorario(' + numero_id + ')"><span class="glyphicon glyphicon-trash"></span></button></td>'

        var div_tabla_horarios = document.getElementById("div-tabla-horarios");
        div_tabla_horarios.hidden = false;
    }

    function eliminarHorario(idHorario) {
        var tabla = document.getElementById("tabla_horarios");

        var horarios = tabla.rows;
        horarios["horario_" + idHorario].remove()

        if (tabla.rows.length == 1) { //Siempre una fila es el encabezado
            var div_tabla_horarios = document.getElementById("div-tabla-horarios");
            div_tabla_horarios.hidden = true;
        }
    }

    function convertirHorario(horario) {
        var hora = parseInt(horario.substring(0,2));
        var minutos = parseInt(horario.substring(3));
        if (minutos == 30)
            hora += 0.5;
        return hora;
    }

    function horarioParaAgregarEsValido(dia, hora_desde, hora_hasta) {
        var error_label = document.getElementById("error_label_horario");

        hora_desde = convertirHorario(hora_desde);
        hora_hasta = convertirHorario(hora_hasta);

        var horarios = document.getElementById("tabla_horarios").rows;
        for (var i=0; i<horarios.length; i++) {
            var horario = horarios[i];
            var dia_actual = horario.cells[0].innerText;

            if (dia_actual != dia)
                continue;

            var hora_desde_actual = convertirHorario(horario.cells[1].innerText);
            var hora_hasta_actual = convertirHorario(horario.cells[2].innerText);

            //El curso empieza despues de que termina el nuevo
            if (hora_desde_actual >= hora_hasta)
                continue;

            //El curso comienza antes que el nuevo y termina antes que el
            if (hora_desde_actual < hora_desde && hora_hasta_actual < hora_desde)
                continue;

            error_label.style["display"] = "";
            return false;
        }

        error_label.style["display"] = "none";
        return true;
    }




</script>

<div class="container">

    <h2>{%trans%}Nuevo Plan de Estudios{%endtrans%}</h2>

    <br>

    {% if carreras | length > 0 %}
    <label>Seleccioná las preferencias con las cuales querés generar el nuevo plan.</label>

    <br>
    <br>

    <form>
        <label>Carrera:</label>
        {% for carrera in carreras %}
        <div class="radio" id="carrera-{{carrera['id_carrera']}}">
            <label><input type="radio" name="opcion-carrera">{{carrera["descripcion"]}}</label>
        </div>
        {% endfor %}

        <br>
        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label>Máxima cantidad de cuatrimestres de duración:</label>
                    <div class="row">
                        <div class="col-sm-4">
                            <input type="number" class="form-control" name="maxima_cantidad_cuatrimestres"
                                   id="maxima_cantidad_cuatrimestres" value="1"
                                   min="1" max="24" step="1">
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label>Máxima cantidad de materias por cuatrimestre:</label>
                    <div class="row">
                        <div class="col-sm-4">
                            <input type="number" class="form-control" name="maxima_cantidad_materias_por_cuatrimestre"
                                   id="maxima_cantidad_materias_por_cuatrimestre" value="1"
                                   min="1" max="10" step="1">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label>Máxima cantidad de horas de cursada por semana:</label>
                    <div class="row">
                        <div class="col-sm-4">
                            <input type="number" class="form-control" name="maxima_cantidad_hs_por_semana"
                                   id="maxima_cantidad_hs_por_semana" value="1"
                                   min="1" max="144" step="1">
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label>Máxima cantidad de horas extra que le querés dedicar por semana al conjunto de
                        materias:</label>
                    <div class="row">
                        <div class="col-sm-4">
                            <input type="number" class="form-control" name="maxima_hs_extra_por_semana"
                                   id="maxima_hs_extra_por_semana" value="1"
                                   min="1" max="168" step="1">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <label>Horarios en los cuales no podés cursar:</label>

        <div>
            <div class="row">
                <div class="col-sm-2">
                    <div class="form-group">

                        <select class="form-control" id="horario-dia" name="horario-dia">
                            {% for dia in dias %}
                            <option>{{dia}}</option>
                            {% endfor %}
                        </select>

                    </div>
                </div>

                <div class="col-xs-1">
                    <p>De:</p>
                </div>

                <div class="col-sm-2">
                    <div class="form-group">
                        <select class="form-control" id="hora_desde" name="hora_desde" onchange="actualizarHoraHasta()">
                            {% for i in range(hora_desde | length) %}
                            <option id="hora_desde_{{i}}">{{hora_desde[i]}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="col-xs-1">
                    <p>A:</p>
                </div>

                <div class="col-sm-2">
                    <div class="form-group">
                        <select class="form-control" id="hora_hasta" name="hora_hasta">
                            {% for i in range(hora_hasta | length) %}
                            <option id="hora_hasta_{{i}}">{{hora_hasta[i]}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="col-sm-2">
                    <div class="form-group">
                        <button type="button" class="btn btn-mussa-default"
                                onclick="agregarHorario()">Agregar horario
                        </button>
                    </div>
                </div>

            </div>

            <div class="alert alert-danger" id="error_label_horario" style="display:none">
                Este horario es incompatible con los que cargaste previamente.
            </div>

        </div>

        <br>

        <div class="form-group" id="div-tabla-horarios" hidden="true">
            <div class='table-responsive'>
                <table class='table table-hover' id="tabla_horarios">
                    <tr>
                        <th>Dia</th>
                        <th>De</th>
                        <th>A</th>
                        <th>Eliminar</th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>

    </form>

    {% else %}

    <p style="font-style: italic; color: purple; font-size: large;">
        No tenés ninguna carrera en la que estés registrado.
    </p>
    <p style="font-style: italic; color: purple; font-size: large;">
        Cuando te registres en una o más carreras podrás generar sus correspondientes planes de estudios personalizados
        desde esta sección.
    </p>

    {% endif %}
</div>

{% endblock %}