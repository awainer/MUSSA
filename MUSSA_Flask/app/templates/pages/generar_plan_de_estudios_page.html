{% extends "common/page_base.html" %}

{% block content %}
<script>

    $( function () {
        var cant_carreras = {{carreras | length}};
        if (cant_carreras == 1) {
            var opcion = document.getElementsByName('opcion-carrera')[0];
            opcion.checked = true;
        }
    });

    function actualizarHoraHasta() {
        var hora_desde_element = document.getElementById("hora_desde");
        var indice_seleccionado = hora_desde_element.selectedIndex;

        var hora_hasta_element = document.getElementById("hora_hasta");
        for (var i=0; i < hora_hasta_element.length; i++) {
            var opcion = hora_hasta_element[i];
            if (i < indice_seleccionado)
                opcion.style["display"] = "none";
            else
                opcion.style["display"] = "";
        }

        hora_hasta_element.selectedIndex = indice_seleccionado;
     }

    function agregarHorario() {
        var dia_element = document.getElementById("horario-dia")
        var dia = dia_element[dia_element.selectedIndex].innerHTML;

        var hora_desde_element = document.getElementById("hora_desde");
        var hora_desde = hora_desde_element[hora_desde_element.selectedIndex].innerHTML;

        var hora_hasta_element = document.getElementById("hora_hasta");
        var hora_hasta = hora_hasta_element[hora_hasta_element.selectedIndex].innerHTML;

        if (!horarioParaAgregarEsValido(dia, hora_desde, hora_hasta))
            return false;

        agregarHorarioATabla(dia, hora_desde, hora_hasta);
    }

    function agregarHorarioATabla(dia, hora_desde, hora_hasta) {
        var horarios_table = document.getElementById("tabla_horarios");
        var horarios = horarios_table.rows;

        var indice = horarios_table.rows.length;
        var row = horarios_table.insertRow(indice);
        var ultimo_id = horarios_table.rows[indice-1].id
        var numero_id = parseInt(ultimo_id.substr(ultimo_id.indexOf("_")+1)) + 1;
        if (isNaN(numero_id))
            numero_id = 0;

        row.id = "horario_" + numero_id;
        row.insertCell(0).innerHTML = dia;
        row.insertCell(1).innerHTML = hora_desde;
        row.insertCell(2).innerHTML = hora_hasta;
        row.insertCell(3).innerHTML = '<button type="button" class="btn btn-default" onclick="eliminarHorario(' + numero_id + ')"><span class="glyphicon glyphicon-trash"></span></button></td>'

        var div_tabla_horarios = document.getElementById("div-tabla-horarios");
        div_tabla_horarios.hidden = false;
    }

    function eliminarHorario(idHorario) {
        var tabla = document.getElementById("tabla_horarios");

        var horarios = tabla.rows;
        horarios["horario_" + idHorario].remove()

        if (tabla.rows.length == 1) { //Siempre una fila es el encabezado
            var div_tabla_horarios = document.getElementById("div-tabla-horarios");
            div_tabla_horarios.hidden = true;
        }
    }

    function convertirHorario(horario) {
        var hora = parseInt(horario.substring(0,2));
        var minutos = parseInt(horario.substring(3));
        if (minutos == 30)
            hora += 0.5;
        return hora;
    }

    function horarioParaAgregarEsValido(dia, hora_desde, hora_hasta) {
        var error_label = document.getElementById("error_label_horario");

        hora_desde = convertirHorario(hora_desde);
        hora_hasta = convertirHorario(hora_hasta);

        var horarios = document.getElementById("tabla_horarios").rows;
        for (var i=0; i<horarios.length; i++) {
            var horario = horarios[i];
            var dia_actual = horario.cells[0].innerText;

            if (dia_actual != dia)
                continue;

            var hora_desde_actual = convertirHorario(horario.cells[1].innerText);
            var hora_hasta_actual = convertirHorario(horario.cells[2].innerText);

            //El curso empieza despues de que termina el nuevo
            if (hora_desde_actual >= hora_hasta)
                continue;

            //El curso comienza antes que el nuevo y termina antes que el
            if (hora_desde_actual < hora_desde && hora_hasta_actual < hora_desde)
                continue;

            error_label.style["display"] = "";
            return false;
        }

        error_label.style["display"] = "none";
        return true;
    }

    function agregar_tematica() {
        var selector = document.getElementById("selector_tematica");
        var opcionElegida = selector[selector.selectedIndex];

        var idTema = opcionElegida.value;
        var tematica = getCleanedString(opcionElegida.innerText);
        opcionElegida.hidden = true;
        var porcentaje = document.getElementById('porcentaje_tematica').value;

        if (!porcentaje_es_valido(porcentaje))
            return;

        seleccionar_primer_opcion_no_oculta("selector_tematica");

        var tabla_tematicas = document.getElementById("tabla_tematicas");
        var tematicas = tabla_tematicas.rows;

        var indice = tabla_tematicas.rows.length;
        var row = tabla_tematicas.insertRow(indice);
        var ultimo_id = tabla_tematicas.rows[indice-1].id
        var numero_id = parseInt(ultimo_id.substr(ultimo_id.indexOf("_")+1)) + 1;
        if (isNaN(numero_id))
            numero_id = 0;

        row.id = "tematica_" + numero_id;
        row.insertCell(0).innerHTML = tematica;
        row.insertCell(1).innerHTML = porcentaje + "%";
        row.insertCell(2).innerHTML = '<button type="button" class="btn btn-default" onclick="eliminarTematica(' + numero_id + ')"><span class="glyphicon glyphicon-trash"></span></button></td>'

        actualizar_porcentaje_restante();
    }

    function porcentaje_es_valido(valor) {
        var actual = calcular_porcentaje_actual();
        var error_label = document.getElementById('error_label_tematica')

        var msj = "El porcentaje ingresado no es válido. El valor debe ser mayor a 0 y menor o igual que "
        msj += (100 - actual) + "%"

        var es_valido = (valor > 0 && valor <= (100 - actual));
        error_label.innerText = msj

        error_label.hidden = es_valido;
        return es_valido;
    }

    function actualizar_porcentaje_restante() {
        var tabla = document.getElementById("tabla_tematicas");
        var nuevo_porcentaje = (100 - calcular_porcentaje_actual());
        tabla.rows["tematica_0"].cells[1].innerText = nuevo_porcentaje + "%"

        var div_selector = document.getElementById('div_seleccionar_tematicas');
        div_selector.hidden = (nuevo_porcentaje == 0);
    }

    function calcular_porcentaje_actual() {
        var tabla = document.getElementById("tabla_tematicas");
        var porcentaje = 0;
        for (var i=2; i<tabla.rows.length; i++) {
            var texto = tabla.rows[i].cells[1].innerText;
            porcentaje += parseInt(texto.substring(0,texto.indexOf("%")));
        }
        return porcentaje;
    }

    function eliminarTematica(idTematica) {
        var tabla = document.getElementById("tabla_tematicas");
        tabla.rows["tematica_" + idTematica].remove();
        actualizar_porcentaje_restante();
    }






</script>

<div class="container">

    <h2>{%trans%}Nuevo Plan de Estudios{%endtrans%}</h2>

    <br>

    {% if carreras | length > 0 %}
    <label>Seleccioná las preferencias con las cuales querés generar el nuevo plan.</label>

    <br>
    <br>

    <form onsubmit="return false;">
        <label>Carrera:</label>
        {% for carrera in carreras %}
        <div class="radio" id="carrera-{{carrera['id_carrera']}}">
            <label><input type="radio" name="opcion-carrera">{{carrera["descripcion"]}}</label>
        </div>
        {% endfor %}

        <br>
        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label>Máxima cantidad de cuatrimestres de duración:</label>
                    <div class="row">
                        <div class="col-sm-4">
                            <input type="number" class="form-control" name="maxima_cantidad_cuatrimestres"
                                   id="maxima_cantidad_cuatrimestres" value="1"
                                   min="1" max="24" step="1">
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label>Máxima cantidad de materias por cuatrimestre:</label>
                    <div class="row">
                        <div class="col-sm-4">
                            <input type="number" class="form-control" name="maxima_cantidad_materias_por_cuatrimestre"
                                   id="maxima_cantidad_materias_por_cuatrimestre" value="1"
                                   min="1" max="10" step="1">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label>Máxima cantidad de horas de cursada por semana:</label>
                    <div class="row">
                        <div class="col-sm-4">
                            <input type="number" class="form-control" name="maxima_cantidad_hs_por_semana"
                                   id="maxima_cantidad_hs_por_semana" value="1"
                                   min="1" max="144" step="1">
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label>Máxima cantidad de horas extra que le querés dedicar por semana al conjunto de
                        materias:</label>
                    <div class="row">
                        <div class="col-sm-4">
                            <input type="number" class="form-control" name="maxima_hs_extra_por_semana"
                                   id="maxima_hs_extra_por_semana" value="1"
                                   min="1" max="168" step="1">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label>
                        Puntaje mínimo requerido para los cursos a seleccionar:
                        <span class="glyphicon glyphicon-question-sign" aria-hidden="true" data-toggle="tooltip" title="Los cursos no puntuados tienen un puntaje de 0.
                La restricción de puntaje no es tenida en cuenta en el caso de los cursos que se seleccionan manualmente.
                Las materias que se elijan no tendrán un puntaje menor al seleccionado a menos que sean el único curso disponible en el caso de las obligatorias o que las electivas disponibles con esos puntajes no alcancen a cubrir el total de electivas requerido. En estos casos siempre se seleccionará en orden la de mayor puntaje con mayor cantidad de encuestas completas."></span>
                    </label>
                    <div class="row">
                        <div class="col-sm-4">
                            <input type="number" class="form-control" name="puntaje_minimo"
                                   id="puntaje_minimo" value="0" min="0" max="5" step="1">
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-group">
                    <label>
                        Cuatrimestre y año de inicio del plan:
                        <span class="glyphicon glyphicon-question-sign" aria-hidden="true" data-toggle="tooltip"
                              title="En qué momento se desea comenzar a cursar las primeras materias que surjan de este plan. Es necesario diferenciar entre primer y segundo cuatrimestre ya que no todas las materias se dictan en ambos cuatrimestres."></span>
                    </label>
                </div>
            </div>
        </div>

        <label>Horarios en los cuales no podés cursar:</label>

        <div>
            <div class="row">
                <div class="col-sm-2">
                    <div class="form-group">

                        <select class="form-control" id="horario-dia" name="horario-dia">
                            {% for dia in dias %}
                            <option>{{dia}}</option>
                            {% endfor %}
                        </select>

                    </div>
                </div>

                <div class="col-xs-1">
                    <p>De:</p>
                </div>

                <div class="col-sm-2">
                    <div class="form-group">
                        <select class="form-control" id="hora_desde" name="hora_desde" onchange="actualizarHoraHasta()">
                            {% for i in range(hora_desde | length) %}
                            <option id="hora_desde_{{i}}">{{hora_desde[i]}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="col-xs-1">
                    <p>A:</p>
                </div>

                <div class="col-sm-2">
                    <div class="form-group">
                        <select class="form-control" id="hora_hasta" name="hora_hasta">
                            {% for i in range(hora_hasta | length) %}
                            <option id="hora_hasta_{{i}}">{{hora_hasta[i]}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="col-sm-2">
                    <div class="form-group">
                        <button type="button" class="btn btn-mussa-default"
                                onclick="agregarHorario()">Agregar horario
                        </button>
                    </div>
                </div>

            </div>

            <div class="alert alert-danger" id="error_label_horario" style="display:none">
                Este horario es incompatible con los que cargaste previamente.
            </div>

        </div>

        <br>

        <div class="form-group" id="div-tabla-horarios" hidden="true">
            <div class='table-responsive'>
                <table class='table table-hover' id="tabla_horarios">
                    <tr>
                        <th>Dia</th>
                        <th>De</th>
                        <th>A</th>
                        <th>Eliminar</th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>

        <label>Porcentaje de cada temática deseada con el que querés que sean elegidas las materias electivas:
            <span class="glyphicon glyphicon-question-sign" aria-hidden="true" data-toggle="tooltip" title="Esto indica el porcentaje de créditos de materias electivas que deben ser de cada temática, no se tendrá en cuenta las temáticas de materias electivas o de materias seleccionadas especialmente para cursar.
            Te recomendamos dejar un porcentaje libre para que la carrera no se alargue debido a incompatibilidad horaria de algunas de esas materias"></span>
        </label>

        <br>
        <br>

        <div class="row" id="div_seleccionar_tematicas">
            <div class="col-sm-3">
                <div class="form-group">
                    <select class="form-control" id="selector_tematica" name="selector_tematica">
                        {% for tematica in tematicas %}
                        <option id="tematica_opcion_{{tematica['id_tematica']}}" value="{{tematica['id_tematica']}}">
                            {{tematica["tematica"]}}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-sm-3">
                <input type="number" class="form-control" name="porcentaje_tematica"
                       id="porcentaje_tematica" min="0" max="100" step="1">
            </div>
            <div class="col-sm-2">
                <button class="btn btn-mussa-default"
                        onclick="agregar_tematica()">Agregar
                </button>
            </div>

        </div>

        <div class="alert alert-danger" id="error_label_tematica" hidden="true"></div>

        <div class="form-group" id="div-tabla-tematicas">
            <div class='table-responsive'>
                <table class='table table-hover' id="tabla_tematicas">
                    <tr>
                        <th>Temática</th>
                        <th>Porcentaje</th>
                        <th>Eliminar</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr id="tematica_0">
                        <th>Cualquier temática</th>
                        <th>100 %</th>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <br>

    </form>

    {% else %}

    <p style="font-style: italic; color: purple; font-size: large;">
        No tenés ninguna carrera en la que estés registrado.
    </p>
    <p style="font-style: italic; color: purple; font-size: large;">
        Cuando te registres en una o más carreras podrás generar sus correspondientes planes de estudios personalizados
        desde esta sección.
    </p>

    {% endif %}
</div>

{% endblock %}