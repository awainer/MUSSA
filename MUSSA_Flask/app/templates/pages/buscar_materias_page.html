{% extends "common/page_base.html" %}

{% block content %}

    <script type='text/javascript' src="/js/services.js"></script>

    <script>

        function generar_tabla_de_resultados(materias) {
            if (!materias || materias.length == 0)
                return "<p>No se encontraron resultados</p>";

            html = "";
            html += "<div class='table-responsive'>";
            html += "<table class='table'>";
            html += "<tr>";
            html += "<th>Código</th>";
            html += "<th>Materia</th>";
            html += "<th>Carrera</th>";
            html += "<th>Acciones</th>";
            html += "</tr>";
            html += "</thead>";

            html += "<tbody>";

            for (i = 0; i<materias.length; i++) {
                materia = materias[i];

                html += "<tr>";
                html += "<td>" + materia["codigo"] + "</td>";
                html += "<td>" + materia["nombre"] + "</td>";
                html += "<td>" + materia["carrera"] + "</td>";
                html += "<td>" + "<a href='/materias/" + materia["id_materia"] + "'><span class='glyphicon glyphicon-search'></span></a>" + "</td>";
                html += "</tr>";
            }

            html += "</tbody>";
            html += "</table>";
            html += "</div>";

            return html;
        }

        function obtener_parametro_ids_carreras() {
            carreras = []
            checkbox = $("input:checkbox[name^='carrera-']")
            checkbox.each(function(index, e){
                if ( checkbox[index].checked ) {
                    carreras.push(checkbox[index].value)
                }
            })
            return carreras;
        }

        function search_materias() {
            $('#loader').show();

            var csrf_token = '{{ csrf_token() }}';
            var codigo = $("#codigo_materia").val();
            var nombre = $("#nombre_materia").val();
            var ids_carreras = obtener_parametro_ids_carreras();

            get_materias_con_filtro_service(csrf_token, codigo, nombre, ids_carreras, function(state, result) {
                content = generar_tabla_de_resultados(result);
                $("#search_results").html(content);
                $('#loader').hide();
            }, function(state, result){
                content = "<p>Ha ocurrido un problema. Por favor intentá nuevamente</p>";
                $("#search_results").html(content);
                $('#loader').hide();
            });
        }

        function change_checkbox_carreras(checkbox) {
            if (checkbox.name == "check_todas_las_carreras") {
                checkbox_carrera = $("input:checkbox[name^='carrera-']")
                checkbox_carrera.each(function(index, e){
                    checkbox_carrera[index].checked = checkbox.checked;
                })
            } else {
                $("input:checkbox[name^='check_todas_las_carreras']")[0].checked = false;
            }
        }

    </script>

    <div class="container">

        <div id="loader" class="loading col-lg-1 col-centered" hidden></div>

        <h2>{%trans%}Buscar Materias{%endtrans%}</h2>

        <form action="{{ url_for('main.buscar_materias_page') }}" method="GET">
            <div class="form-group">
                <label for="codigo_materia">Codigo de materia:</label>
                <input type="text" class="form-control" id="codigo_materia" name="codigo_materia">
            </div>

            <div class="form-group">
                <label for="nombre_materia">Nombre de la materia:</label>
                <input type="text" class="form-control" id="nombre_materia" name="nombre_materia">
            </div>

            <div class="form-group">
                <label>Carreras:</label>

                <div class="checkbox" id="check_todas_las_carreras">
                    <label>
                        <input type="checkbox" onchange="change_checkbox_carreras(this)" name="check_todas_las_carreras">Todas las carreras
                    </label>
                </div>

                {% for carrera in carreras %}
                    <div class="checkbox" id="carrera-{{carrera.codigo}}">
                        <label>
                            <input type="checkbox" name="carrera-{{carrera['codigo']}}" onchange="change_checkbox_carreras(this)" value="{{carrera['id_carrera']}}">{{ carrera['codigo'] }} - {{ carrera['nombre'] }}
                        </label>
                    </div>
                {% endfor %}

            </div>

            <!--div>Agregar la seleccion de palabras clave</div-->

            <button type="button" onclick="search_materias()" class="btn btn-mussa-default">Buscar</button>

        </form>

        <br>

        <div id="search_results"></div>

    </div>

{% endblock %}